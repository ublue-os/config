#!/usr/bin/env bash
##################################################################
# This is a helper script to provide a basic fallback replacement 
# for just commands and bash scripts that want to use gum in uBlue
##################################################################

# Check if gum is present
GUM=$(which gum 2>/dev/null)

function nogum () {
    if [[ -z "$1" ]]; then
        # If no arguments are provided then error with 
        echo "ugum supports only choose or confirm as the first argument!"
        exit 5
    elif [[ "$1" == "choose" ]]; then
        # If choose is the verb then run the choose function and pass all remaining args to it
        choose "${@:2}"
    elif [[ "$1" == "confirm" ]]; then
        confirm "${@:2}" 
    fi
}

function choose () {
    # Change PS3 to our select prompt
    PS3='Please enter your choice: '

    # Make an array to contain all options in
    OPTIONS=()

    # Parse the arguments for the ones we support and care about
    for arg in "$@"
    do
        # If the argument does not start with -
        if [[ ! $arg =~ ^- ]]; then
            OPTIONS+=("$arg")
        fi
    done

    # Make a select prompt in bash
    select opt in "${OPTIONS[@]}"
    do
        case $opt in
            "")
                # Invalid options print to STDERR and then loops back for the user to select again
                echo "Invalid option $REPLY" >&2
                ;;
            "$opt")
                echo "$opt"
                break
                ;;
        esac
    done 
}

function confirm () {
    # Set default prompt
    PROMPT="Are you sure?"

    # Parse the arguments for the ones we support and care about 
    for arg in "$@"
    do
        if [[ ! $arg =~ ^- ]]; then
            PROMPT="$arg"
        fi
    done

    # Print the prompt and read input
    read -r -p "$PROMPT [Y/n]: " YESNO
    case "${YESNO}" in
        [Yy]*)
            # Use exit code 0 for yes, just like gum
            exit 0
            ;;
        [Nn]*)
            # Use exit code 1 for no, just like gum
            exit 1
            ;;
        *)
            # Default exit code is 0
            exit 0
            ;;
    esac
}

# If gum is not present
if [[ -z "$GUM" ]]; then
    nogum "$@"
else
    # If gum is present just pass args to gum
    $GUM "$@"
fi
